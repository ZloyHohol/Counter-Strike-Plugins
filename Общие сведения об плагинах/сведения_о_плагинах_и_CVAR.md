# Сведения о плагине SoundManifest и его CVAR

## Общие сведения

**Название плагина:** SoundManifest (V3.2)  
**Путь к файлу плагина:** `cstrike/addons/sourcemod/plugins/SoundManifest-V3.2.smx`  
**Автор:** Gemini for ZloyHohol  
**Текущий разработчик:** Qwen (основная ветвь)  
**Назначение:** Плагин для воспроизведения звуков и сообщений при различных игровых событиях

## Требуемые файлы для работы

### Основные файлы плагина
- `cstrike/addons/sourcemod/plugins/SoundManifest-V3.2.smx` - Скомпилированный плагин
- `cstrike/addons/sourcemod/scripting/SoundManifest-V3.2.sp` - Исходный код плагина (если нужен для разработки)

### Конфигурационные файлы
- `cstrike/addons/sourcemod/configs/SoundManifestConfiguration.cfg` - Основная конфигурация событий, звуков и аудитории
- `cstrike/cfg/sourcemod/SoundManifest-extra.cfg` - Автоматически загружаемый конфиг с CVAR настройками

### Файлы переводов
- `cstrike/addons/sourcemod/translations/SM_SoundManifest.phrases.txt` - Файл переводов для сообщений

### Звуковые файлы
- `sound/plugins/soundmanifest/` - Каталог с аудиофайлами (плагин не поддерживает Virtual File System в custom папках)

## Поддерживаемые CVAR

| Имя CVAR | Значение по умолчанию | Описание |
|----------|----------------------|----------|
| `sm_soundmanifest_version` | 3.2 | Версия плагина (только для чтения) |
| `sm_soundmanifest_enabled` | 1 | Включить/выключить плагин (1 = вкл, 0 = выкл) |
| `sm_soundmanifest_join_delay` | 3.0 | Задержка перед воспроизведением приветственного звука (в секундах) |
| `sm_soundmanifest_join_audience` | 0 | Кто слышит приветственный звук (0 = только игрок, 1 = все) |
| `sm_soundmanifest_join_interval` | 10.0 | Минимальный интервал между приветственными звуками (в секундах) |
| `sm_soundmanifest_default_setting` | 1 | Включены ли звуки по умолчанию для новых игроков (1 = да, 0 = нет) |
| `sm_soundmanifest_justicekill_threshold` | 2 | Количество тимкиллов, после которого срабатывает JusticeKill |
| `sm_soundmanifest_combokill_time` | 4.0 | Время в секундах для комбо убийств |
| `sm_soundmanifest_quadkill_threshold` | 4 | Количество убийств для QuadKill |
| `sm_soundmanifest_epicstreak_threshold` | 5 | Порог для эпических серий убийств |
| `sm_soundmanifest_cooldown_interval` | 2.0 | Минимальный интервал между повторениями одного и того же звука (секунды) |
| `sm_soundmanifest_debug_level` | 0 | Уровень отладки (0=ошибки, 1=предупреждения, 2=информация, 3=отладка) |
| `sm_soundmanifest_max_file_size` | 50 | Максимальный размер звукового файла в MB |
| `sm_soundmanifest_max_sounds_per_event` | 5 | Максимальное количество звуков на событие (1-5) |

## Влияние CVAR на работу плагина

- `sm_soundmanifest_enabled` - Полностью включает или отключает функциональность плагина
- `sm_soundmanifest_join_*` параметры управляют поведением приветственных звуков
- `sm_soundmanifest_justicekill_threshold` - Определяет порог для срабатывания события JusticeKill
- `sm_soundmanifest_combokill_time` - Влияет на определение комбо убийств
- `sm_soundmanifest_*kill_threshold` параметры - Устанавливают пороги для различных серий убийств
- `sm_soundmanifest_cooldown_interval` - Предотвращает спам звуками одного типа
- `sm_soundmanifest_debug_level` - Управляет количеством отладочной информации в консоли сервера
- `sm_soundmanifest_max_file_size` и `sm_soundmanifest_max_sounds_per_event` - Ограничения безопасности

## Технические особенности и изменения

### Структурные изменения

1. **Система отдельных HUD сообщений:**
   - Введены отдельные ключи для HUD сообщений (например, `FirstBlood_HUD`, `Headshot_HUD`)
   - Решает проблему с цветовыми тегами в HUD, которые не поддерживаются библиотекой `easy_hudmessage`
   - Функция `GetHudMessageKey()` преобразует обычные ключи сообщений в HUD-специфичные

2. **Селективная система уведомлений:**
   - События оружейных убийств (RifleKill, SMGKill, и т.д.) считаются "банальными" и исключаются из объявления
   - Только значимые события (FirstBlood, Headshot, KillStreaks и др.) получают аудио/текстовые уведомления

3. **Поддержка различных аудиторий:**
   - Возможность указать разную аудиторию для разных звуков одного события
   - Поддержка командных звуков (CT/T) для разных команд

### Логические изменения

1. **Обработка событий:**
   - Система приоритетов событий: Suicide → TeamKill → JusticeKill → FirstBlood → KillStreaks → Primary Events (Headshot, Weapon kills)
   - Улучшенное отслеживание FirstBlood (учет только первого убийства в раунде)
   - Правильное отслеживание комбо убийств и эпических серий

2. **Система кеширования:**
   - Все звуковые файлы проходят проверку на наличие и валидность
   - Поддержка форматов: .wav, .mp3, .ogg
   - Ограничение по размеру файлов

### Проблемы совместимости

**Проблема с Virtual File System в CS:S:**
- В CS:S была введена виртуальная файловая система для модов в каталоге `cstrike/custom/`
- Звуки, размещенные в `cstrike/custom/custom_audio/sound/plugins/soundmanifest/`, не обнаруживаются плагином
- Плагин ожидает звуки по пути: `sound/plugins/soundmanifest/` (прямой путь)
- Это связано с тем, что плагин использует `FileExists()` и `PrecacheSound()` которые не работают с VFS
- **Решение:** Размещать звуковые файлы в традиционных папках `sound/plugins/soundmanifest/` вместо `cstrike/custom/custom_audio/`

**Проблемы с передачей аудио файлов клиенту:**
- Система `AddFileToDownloadsTable()` работает, но иногда сервер может "зависать" при сжатии аудио перед отправкой
- Это может происходить при большом количестве файлов или больших размерах аудио

## Как плагин обрабатывает события

## Последние изменения (8 ноября 2025)

### Проблема с именами файлов конфигурации
- **Проблема:** В QWEN версии плагина использовалось неправильное имя файла конфигурации
- **Решение:** Замена `SoundManifest_Sounds.ini` на `SoundManifestConfiguration.cfg`
- **Влияние:** Исправлена проблема с отображением имен игроков вместо плейсхолдеров `{1:N} {2:N}`
- **Корректировка заблуждения:** Gemini предполагал, что его изменения в коде форматирования сообщений гарантированно решат проблему, но настоящей причиной были неправильные имена файлов конфигурации

### Исправление отображения имен игроков
- **Проблема:** В обеих версиях (QWEN и Gemini) плагин пытался использовать значение из конфигурации как ключ перевода, но если в конфиге было не имя ключа, а готовый текст с плейсхолдерами, система не могла заменить `{1:N} {2:N}` на имена игроков
- **Решение:** Убедились, что в конфигурационном файле указаны названия ключей перевода, а не готовый текст с плейсхолдерами
- **Результат:** Имена игроков теперь корректно отображаются вместо плейсхолдеров

## Последующие изменения (9 ноября 2025)

### Интеграция с DeathInformer плагином
- **Идея:** Объединение функционала SoundManifest и DeathInformer за счет общих систем обработки событий
- **Преимущества:** Возможность создания общей библиотеки для обработки данных о смертях и повреждениях
- **Бенефиты:** Уменьшение дублирования кода, упрощение обслуживания, улучшенная совместимость
1. **При регистрации события (например, `player_death`):**
   - Производится приоритезация (суицид → тимкилл → джастискилл → ферстблуд → килстрики → основные события)
   - Проверяется тип оружия и другие параметры (хедшот, тип гранаты и т.д.)
   - Определяется тип события для воспроизведения

2. **Перед воспроизведением:**
   - Проверяется, включена ли система у игрока (через cookie)
   - Проверяется cooldown (время между одинаковыми звуками)
   - Определяется аудитория для звука и сообщения

3. **Воспроизведение:**
   - Выбирается случайный звук из доступных для события
   - Если настроены командные звуки (CT/T), выбирается соответствующий набор
   - Воспроизводится звук определенной аудитории
   - Отправляется сообщение в чат (если настроено)
   - Отправляется HUD сообщение (для значимых событий)

## Аудитория событий

- `killer` - убийца
- `victim` - жертва
- `killer_team` - команда убийцы
- `victim_team` - команда жертвы
- `all_alive` - все живые игроки
- `all` - все игроки

## Команды плагина

- `sm_soundmanifest` или `soundmanifest` - Открытие меню настроек
- `sm_soundmanifest_reset_cooldowns` - Сброс всех кулдаунов (только для администраторов с флагом `b`)

## Заключение

Плагин SoundManifest предоставляет гибкую систему воспроизведения звуков для различных игровых событий с возможностью тонкой настройки. Несмотря на проблемы с VFS в CS:S, плагин успешно работает с файлами в стандартных директориях и предоставляет богатую функциональность для улучшения игрового опыта.
---
# Сведения о плагине Death Informer и его CVAR

## Общие сведения

**Название плагина:** Death Informer Enhanced (v3.6)
**Путь к файлу плагина:** `cstrike/addons/sourcemod/plugins/DeathInformer.smx`
**Автор:** Gemini for ZloyHohol
**Назначение:** Плагин для отображения подробной информации об убийстве сразу после смерти игрока.

## Требуемые файлы для работы

### Основные файлы плагина
- `cstrike/addons/sourcemod/plugins/DeathInformer.smx` - Скомпилированный плагин
- `cstrike/addons/sourcemod/scripting/DeathInformer.sp` - Исходный код плагина

### Файлы переводов
- `cstrike/addons/sourcemod/translations/deathinformer.phrases.txt` - Файл переводов для сообщений (поддерживает ru, en, ua, de).

## Поддерживаемые CVAR

| Имя CVAR | Значение по умолчанию | Описание |
|----------|----------------------|----------|
| `sm_deathinformer_history_time` | 30.0 | Как долго (в секундах) отслеживать историю урона от атакующего перед смертью. |
| `sm_deathinformer_detail_info` | 1 | Включить (1) или выключить (0) отображение детальной информации о зонах попадания. |
| `sm_deathinformer_shotgun_agg` | 1 | Включить (1) или выключить (0) агрегацию (суммирование) урона от дробовиков. |

## Технические особенности и последние изменения (10 ноября 2025)

Плагин был полностью переработан для устранения критических ошибок, приводивших к падению сервера и отсутствию сообщений в чате.

1.  **Исправление падений:** Устранена ошибка `Property "m_iArmorValue" not found` путем возврата к использованию стабильной, хотя и устаревшей, функции `GetClientArmor()`. Это обеспечивает работу плагина на текущей конфигурации сервера.
2.  **Надежный вывод в чат:** Переписана логика форматирования сообщений. Теперь плагин использует библиотеку `multicolors` и многоступенчатый подход "получение перевода -> форматирование с цветом -> вывод", что решает проблемы с некорректным отображением имён и цветов.
3.  **Многоязычность:** Добавлена поддержка русского, английского, украинского и немецкого языков через файл переводов.
