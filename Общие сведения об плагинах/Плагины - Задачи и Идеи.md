# Плагины - Задачи, Идеи и Известные Проблемы

Этот документ содержит список задач, идей для улучшения и известных проблем для различных плагинов, основанный на обратной связи.

---

## 1. PlayerRewardAndDiscipline (PRD)

*   **Статус:** Требует доработки.

*   **Проблема с MVP:** Секция MVP/СЦИ работает некорректно, особенно с ботами. Либо не начинается голосование, либо не начисляются деньги по его итогам. Требуется тестирование с реальными игроками для полной диагностики.

*   **Проблема с наказанием за тимкилл:** Система наказаний за убийство союзников не функционирует должным образом. Возможные причины: либо выбран режим по умолчанию, несовместимый с ботами (которые не могут голосовать), либо система не регистрирует тимкиллы от ботов.

---

## 2. HUD_Damage

*   **Статус:** Требует улучшения.

*   **Идея по улучшению:** Добавить отображение оставшейся брони у жертвы в HUD-сообщении о нанесенном уроне.

*   **Идея по локализации и формату:** Изменить текущий формат вывода `Урон -%i | Осталось - %s/ХП` на более компактный и информативный, включающий броню. Предлагаемый формат: `{значение}Ж | {значение}Б` (где Ж - Жизни, Б - Броня). Это позволит атакующему лучше оценивать "живучесть" цели.

---

## 3. SmokeBombCombo (SBC_V3)

*   **Статус:** Требует доработки.

*   **Проблема с асинхронностью:** Эффекты плагина (урон и окрашивание дыма) прекращаются примерно за 1.5-2 секунды до того, как дым визуально полностью рассеется. Это создает рассинхронизацию между визуальным эффектом и его действием.

*   **Идея по улучшению:** Вынести в отдельный CVAR время действия эффектов плагина (токсичности и окрашивания). Это позволит администраторам гибко настраивать длительность эффектов, не прибегая к перекомпиляции плагина, особенно если в будущем появится возможность изменять стандартное время жизни дымовой гранаты.

---

## 4. SkinChooser v5.5

*   **Статус:** План для будущих версий.

*   **Интеграция с PRD (система "Клоун" за тимкилл):**
    *   **Задача:** Реализовать функционал, аналогичный старому плагину `tkclown.sp`. При наказании игрока за тимкилл через систему **PRD**, его модель должна принудительно меняться на "обидный" скин (например, скин клоуна).
    *   **Задача:** Во время действия этого наказания, игроку необходимо заблокировать доступ к меню `!models`. Он не должен иметь возможности сменить "наказанный" скин или сбросить его на стандартный.

*   **Возвращение вида от третьего лица:**
    *   **Задача:** Восстановить функционал просмотра своей модели от третьего лица, который был в старых версиях плагина (например, v5.3). Реализовать команды `!thirdon` / `!thirdoff`.
    *   **Ключевое требование:** Эта функция не должна требовать активации `sv_cheats 1` на сервере.

---

## 5. SoundManifest

*   **Статус:** <span style="color:green">**ИСПРАВЛЕНО**</span>.

*   **Проблема:** Плагин переставал работать после первого раунда при наличии файлов перевода.
*   **Решение:** Проблема была в конфликте сторонней функции `SendHudMessage` с системой переводов SourceMod. Плагин был исправлен, чтобы сначала подготавливать переведенный текст и только потом отправлять его в HUD. (См. детальное описание ниже).

---

## 6. Анализ логов от 2025-11-04 @ 18:35

На основе файлов `errors_20251104.log` и `L20251104.log` выявлены следующие технические проблемы:

*   **PlayerRewardAndDiscipline.smx:**
    *   **Ошибка:** `[SM] Exception reported: Invalid timer handle`
    *   **Описание:** Плагин генерирует множество ошибок, связанных с попыткой удалить недействительный или уже удаленный таймер. Это происходит в основном при спавне игроков (`Event_PlayerSpawn`), их отключении (`OnClientDisconnect`) и при смене карты (`OnMapStart`). Проблема указывает на фундаментальную ошибку в логике управления таймерами в плагине.

*   **SoundManifest-v3.smx:**
    *   **Ошибка:** `[SM] Exception reported: Language phrase "..." not found`
    *   **Описание:** Плагин не может найти в файле перевода ключевые фразы для игровых событий, такие как `FirstBlood_Message`, `SpecialKill_Message`, `Combo_Message`, `Suicide_Message`. Это приводит к ошибкам во время игры при наступлении этих событий.

*   **Файлы переводов (*.phrases.txt):**
    *   **Ошибка:** `[SM] Warning(s) encountered in translation file...`
    *   **Описание:** Файлы `PlayerRewardAndDiscipline.phrases.txt` и `SM_SoundManifest.phrases.txt` содержат многочисленные синтаксические ошибки (недопустимые символы, лишние пробелы, неверный формат). Из-за этих ошибок SourceMod не может корректно загрузить фразы, что является **основной причиной** ошибок в `SoundManifest-v3.smx` и, возможно, влияет на работу `PlayerRewardAndDiscipline.smx`.
    *   **Рекомендация:** Необходимо тщательно проверить и исправить оба файла переводов в соответствии с синтаксисом SourceMod.

---

### SoundManifest - Исправление зависания после 1-го раунда (Детально)

**Проблема:**
Плагин `SoundManifest` переставал обрабатывать игровые события (звуки, HUD-сообщения) после окончания первого раунда. Проблема проявлялась только при наличии файла перевода (`SM_SoundManifest.phrases.txt`).

**Причина:**
Ошибка была вызвана конфликтом между сторонней функцией `SendHudMessage` (из `easy_hudmessage.inc`) и системой переводов SourceMod. Передача ключа фразы и параметров форматирования (`%t`, имя игрока и т.д.) напрямую в `SendHudMessage` приводила к внутреннему сбою, который "ломал" обработку событий для последующих раундов.

**Решение:**
Код плагина был изменен. Теперь он не доверяет обработку перевода функции `SendHudMessage`. Вместо этого, плагин сначала самостоятельно формирует готовую текстовую строку со всеми переводами и параметрами с помощью стандартной функции `Format()`, и только потом передает эту готовую строку в `SendHudMessage` для отображения. Это устранило конфликт и решило проблему.