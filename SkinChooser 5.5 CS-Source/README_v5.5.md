# sm_skinchooser v5.5 (CSS)

Версия плагина, доработанная и исправленная в сотрудничестве с ZloyHohol.
Оригинальный репозиторий: [https://github.com/ZloyHohol/Counter-Strike-Plugins/](https://github.com/ZloyHohol/Counter-Strike-Plugins/)

## История изменений (v5.4 -> v5.5)

Эта версия является крупным рефакторингом и исправлением ошибок предыдущих версий плагина.

### Ключевые исправления и улучшения:

*   **Полная переработка структуры конфигурации:**
    *   Убраны все файлы `*_downloads.ini`. Плагин теперь автоматически определяет и добавляет в список загрузки все необходимые файлы модели (`.vvd`, `.vtx`, `.phy`) и ее материалы.
    *   Созданы подпапки `configs/sm_skinchooser/maps/` и `configs/sm_skinchooser/force/` для более логичного и гибкого управления скинами для конкретных карт или для принудительной установки.
*   **Упрощение кода:**
    *   Полностью удален функционал, связанный со скинами рук и ботов из CS:GO, для упрощения кода и повышения стабильности в CS:Source.
*   **Исправление ошибок с моделями:**
    *   Убрана ненадёжная проверка на существование файла (`FileExists`), которая приводила к "ERROR" моделям из-за особенностей виртуальной файловой системы движка Source.
    *   Реализован механизм сохранения и восстановления стандартной модели игрока.

## План работ на версию 5.5

1.  **Динамическая перезагрузка конфигурации:**
    *   Реализовать автоматическую перезагрузку всех скинов в начале каждой карты (`OnMapStart`).
    *   Добавить админ-команду `sm_reload_skins` для ручной перезагрузки конфигов без смены карты.
2.  **Возврат к стандартной модели:**
    *   Добавить в меню `!models` пункт `[ Вернуть стандартную модель ]` для удобного сброса кастомного скина.
3.  **Проверка логики флагов:**
    *   Проверить и убедиться в корректной работе системы флагов и групп доступа к скинам на современных версиях SourceMod.
// известен глюк - сломано распознавание игрока к группам, любой игрок может выбирать любые секции, не смотря на админский флаг (в том числе z).

## История изменений (v5.5 -> v5.5.1)

Эта версия является дальнейшим развитием и исправлением критических ошибок, обнаруженных в v5.5.

### Ключевые исправления и улучшения:

*   **Исправлена фильтрация меню по флагам:** Теперь группы моделей в меню `!models` корректно фильтруются в зависимости от флагов доступа игрока. Игроки без соответствующих флагов не видят административные группы.
*   **Исправлена навигация по меню:** Устранена проблема, из-за которой меню закрывалось после выбора группы моделей. Теперь список моделей отображается корректно.
*   **Исправлена смена моделей:** Выбор модели из списка теперь корректно применяет выбранную модель к игроку.
*   **Исправлены `ERROR` модели и загрузка материалов:** Устранена основная причина появления `ERROR` моделей. Плагин теперь корректно находит и добавляет в список загрузки все необходимые компоненты модели (`.mdl`, `.vvd`, `.dx80.vtx`, `.dx90.vtx`, `.sw.vtx`, `.phy`) и автоматически определяет и добавляет папку с материалами (`materials/models/...`) на основе пути к модели.
*   **Исправлен сброс модели по умолчанию:** Логика сброса модели приведена в соответствие с версией 5.5. Плагин теперь запоминает стандартную модель игрока при каждом возрождении, что гарантирует возврат к правильной модели для текущей команды.
*   **Улучшены уведомления в чате:** Добавлены информативные сообщения в чат при навигации по меню моделей, указывающие на количество доступных моделей или на ошибки при их загрузке. Сообщение о количестве моделей сокращено для предотвращения обрезки.

### Финальные доработки и улучшения (v5.5.1):

*   **Новая система загрузки материалов:** Вместо автоматического определения путей к материалам, теперь используется отдельный файл `configs/sm_skinchooser/default_skins_download_list.ini`. В нем можно построчно перечислить все необходимые `.vmt` и `.vtf` файлы для моделей с нестандартной структурой. Это обеспечивает максимальную надежность и гибкость загрузки.
*   **Отказоустойчивость и диагностика:** Плагин теперь проверяет наличие каждого файла из `default_skins_download_list.ini`. Если файл не найден, он не будет добавлен в загрузку, а в лог сервера запишется ошибка. Если в списке были ошибки, все игроки получат уведомление в чат о возможных проблемах с отображением скинов.
*   **Обратная совместимость конфигов:** Для определения прав доступа к группе плагин теперь проверяет наличие ключа `"Admin"`, а если его нет — `"Flags"`. Это обеспечивает совместимость со старыми версиями конфигурационных файлов.
*   **Правильный сброс модели:** Восстановлена логика, при которой стандартная модель игрока запоминается только один раз при первом спавне на карте, что гарантирует корректный сброс к настоящей дефолтной модели.
*   **Детальное комментирование кода:** Весь код файла `SkinChooser-v55.sp` был подробно прокомментирован для облегчения дальнейшей поддержки и модификации.
*   **Интеграция `multicolors`:** Все сообщения в чате теперь используют библиотеку `multicolors` для лучшей читаемости.

## Финальная версия v5.5.1

Эта версия включает в себя все предыдущие исправления и доработки, а также следующие ключевые изменения:

*   **Раздельное управление сохранением и загрузкой:**
    *   Добавлен CVAR `sm_skinchooser_savechoice` (1/0): Разрешает или запрещает плагину **записывать** выбор игроков в файл.
    *   Добавлен CVAR `sm_skinchooser_loadchoice` (1/0): Разрешает или запрещает плагину **загружать** сохраненный выбор игроков при подключении.
    *   Это позволяет гибко управлять сохранением скинов, например, разрешить сохранение только на один день, а в остальное время только загружать уже сделанный выбор.
*   **Исправлена логика проверки флагов:** Логика фильтрации групп моделей в меню `!models` была полностью переработана. Теперь она использует строгую битовую проверку, аналогичную той, что применяется при загрузке сохраненных моделей. Это обеспечивает корректное иерархическое отображение групп: администраторы с более высокими флагами (например, 'z') видят все группы, доступные для более низких флагов (например, 'b'), а также группы, требующие их специфические флаги. Игроки видят только те группы, для которых у них есть все необходимые флаги.
*   **Исправлена логика сброса модели:** Механизм сброса на стандартную модель полностью переработан. Теперь он корректно работает даже после многократных перезаходов на сервер и смен команд, всегда возвращая игроку его настоящую оригинальную модель для текущей сессии.

### Текущее состояние плагина: Готовность к базовому использованию

После всех внесенных исправлений и доработок, плагин `sm_skinchooser v5.5.1` считается **полностью пригодным для базового использования**.

**Основные функции, работающие корректно:**

*   **Смена моделей:** Игроки могут успешно выбирать и применять различные модели из меню `!models`.
*   **Фильтрация меню по флагам:** Меню `!models` теперь корректно отображает группы моделей в соответствии с флагами доступа игрока, обеспечивая иерархический доступ.
*   **Возврат к стандартной модели:** Функция сброса модели на стандартную работает надежно, возвращая игроку его оригинальную модель для текущей команды.
*   **Загрузка моделей и материалов:** Проблемы с "ERROR" моделями и отсутствующими текстурами устранены. Плагин корректно загружает все необходимые файлы моделей и их материалы.
*   **Сохранение/загрузка выбора:** Функционал сохранения и загрузки выбора игрока работает согласно настройкам CVAR'ов `sm_skinchooser_savechoice` и `sm_skinchooser_loadchoice`.